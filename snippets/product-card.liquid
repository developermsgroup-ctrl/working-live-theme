{%- liquid

  assign new_t = 'products.new' | t
  assign off_t = 'products.off' | t
  assign out_of_stock_t = 'products.out_of_stock' | t
  assign sale_t = 'products.sale' | t

  assign compare_price = false
  assign featured_tags = settings.product--featured-tags | remove: ' ' | split: ','
  assign heading_type = settings.product--heading-type
  assign hide_single_swatch = settings.product--hide-single-swatch
  assign image_aspect_ratio = settings.image--product-size
  assign label_color = settings.product--label-color
  assign label_white_text = settings.product--label-white-text
  assign label_shape = settings.product--label-shape
  assign new_label_period = settings.product--new-label-period
  assign rating_enabled = settings.product--show-rating
  assign show_new_label = settings.product--show-new-label
  assign swatches = settings.product--swatches
  assign show_sale_label = settings.product--show-sale-label
  assign show_vendor = settings.product--show-vendor

  assign swatch_option = false
  assign tag = 'div'
  unless swatches == 'none'
    for option in product_item.options_with_values
      assign swatch_count = option.values | map: 'swatch' | compact | size
      if swatch_count > 0
        assign swatch_option = option
        assign tag = 'product-card'
        break
      endif
    endfor
  endunless

  unless text_alignment
    assign text_alignment = settings.product--text-alignment
  endunless

  if show_new_label
    assign now_timestamp = 'now' | date: '%s'
    assign new_label_period_in_seconds = new_label_period | times: 86400
    assign valid_date = now_timestamp | minus: new_label_period_in_seconds | plus: 0
    assign publish_date = product_item.created_at | date: '%s' | plus: 0

    assign is_new_product = false
    if valid_date < publish_date
      assign is_new_product = true
    endif
  endif

  unless onboarding
    assign onboarding = false
  endunless

  unless placeholder_index
    assign placeholder_index = 1
  endunless

  if onboarding
    assign excerpt = 'sections.onboarding.description' | t
    assign title = 'sections.onboarding.product_title' | t
    assign url = product_item.url | within: collection
    assign vendor = 'sections.onboarding.vendor' | t

  else
    assign title = product_item.title
    assign url = product_item.url | within: collection
    assign vendor = product_item.vendor

    if product_item.compare_at_price > product_item.price and product_item.available
      assign compare_price = product_item.compare_at_price | money
    endif

    assign excerpt = product_item.metafields.global.description_tag | newline_to_br
    if excerpt == blank
      assign excerpt = product_item.description | strip_html | truncate: 100 | newline_to_br
    endif

  endif

  capture display_labels
    unless product_item.available or onboarding
      echo out_of_stock_t
      assign label_type = 'out-of-stock'

    elsif show_sale_label != 'false' and compare_price and onboarding == false
      if show_sale_label == 'show-text'
        assign sale_text = sale_t
      elsif show_sale_label == 'show-percent'
        assign price_diff = product_item.compare_at_price | minus: product_item.price
        assign percent_diff = price_diff | times: 100 | divided_by: product_item.compare_at_price
        assign sale_text = percent_diff | append: '% ' | append: off_t
      endif

      echo sale_text
      assign label_type = 'sale'

    elsif show_new_label and is_new_product and onboarding == false
      echo new_t
      assign label_type = 'new'

    endunless
  endcapture

  capture featured_label
    if featured_tags.size > 0 and product_item.available and onboarding == false
      assign break_loop = false

      for featured_tag in featured_tags
        assign formatted_featured_tag = featured_tag | downcase

        for product_tag in product_item.tags
          assign formatted_product_tag = product_tag | remove: ' ' | downcase

          if formatted_product_tag == formatted_featured_tag
            echo product_tag | escape
            assign label_type = product_tag | handleize
            assign break_loop = true
            break
          endif
        endfor

        if break_loop
          break
        endif
      endfor
    endif
  endcapture
-%}

{%- capture main_image -%}
  {%- if onboarding -%}
    {%-
      render 'placeholder',
      type: 'product',
      placeholder_index: placeholder_index,
      class: 'product-card--image'
    -%}
  {%- else -%}
    {%- if product_item.featured_media.preview_image -%}
      {{-
        product_item.featured_media.preview_image |
        image_url: width: product_item.featured_media.preview_image.width |
        image_tag:
          class: 'product-card--image',
          widths: '200, 300, 400, 500, 600, 700, 800, 900, 1000',
          sizes: sizes,
          loading: loading
      -}}

    {%- else -%}
      {%-
        render 'placeholder',
        type: 'product',
        placeholder_index: placeholder_index,
        class: 'product-card--image'
      -%}

    {%- endif -%}
  {%- endif -%}
{%- endcapture -%}

{%- capture hover_image -%}
  {%- if settings.product--hover-image-enabled -%}
    {%- if product_item.media.size > 1 -%}
      {{-
        product_item.media[1].preview_image |
        image_url: width: product_item.media[1].preview_image.width |
        image_tag:
          class: 'product-card--hover-image',
          widths: '200, 300, 400, 500, 600, 700, 800, 900, 1000',
          sizes: sizes,
          loading: 'lazy'
      -}}
    {%- elsif product_item.media.size == 0 or onboarding -%}
      {%-
        render 'placeholder',
        type: 'collection',
        placeholder_index: placeholder_index,
        class: 'product-card--hover-image'
      -%}
    {%- endif -%}
  {%- endif -%}
{%- endcapture -%}

<{{ tag }}
  class="product-card--root"
  data-handle="{{ product_item.handle }}"
  data-product-item
  data-text-layout="{{ text_alignment }}"
  data-container="block"
  data-aspect-ratio="{{ image_aspect_ratio }}"
  {% unless settings.transitions--other %}
    data-transition-item="{{ transition_id }}"
  {% endunless %}
  {% if swatch_option %}
    data-swatch-option-position="{{ swatch_option.position }}"
  {% endif %}
>
  <a href="{{ url }}" class="product-card--image-wrapper">
    {%- unless display_labels == blank and featured_label == blank -%}
      <div
        class="product--labels"
        data-item="overline"
        data-text-color="{% if label_white_text %}white{% else %}body{% endif %}"
      >
        {%- if display_labels != blank -%}
          <div
            class="product--label"
            data-background-color="{{ label_color }}"
            data-label-shape="{{ label_shape }}"
            data-label-type="{{ label_type }}"
          >
            {{- display_labels -}}
          </div>
        {%- endif -%}
        {%- if featured_label != blank -%}
          <div
            class="product--label"
            data-background-color="{{ label_color }}"
            data-label-shape="{{ label_shape }}"
            data-label-type="{{ label_type }}"
          >
            {{- featured_label -}}
          </div>
        {%- endif -%}
      </div>
    {%- endunless -%}

    {%- liquid
      echo main_image

      if hover_image
        echo hover_image
      endif

      render 'product-quick-add', product: product_item, onboarding: onboarding, hover: true
    -%}
  </a>

  {%- unless onboarding -%}
    {%- if product_item.available -%}
      <button 
        class="product-card--add-to-cart-btn" 
        data-variant-id="{{ product_item.selected_or_first_available_variant.id }}"
        data-product-id="{{ product_item.id }}"
      >
        ADD TO CART
      </button>
    {%- else -%}
      <button class="product-card--add-to-cart-btn product-card--add-to-cart-btn--disabled" disabled>
        OUT OF STOCK
      </button>
    {%- endif -%}
  {%- endunless -%}

  <div class="product-card--details">
    <div class="product-card--details-wrapper">
      {%- comment -%} Always show vendor/brand {%- endcomment -%}
      <div class="product-card--vendor" data-item="sub-nav-text">
        {{- vendor -}}
      </div>

      <a href="{{ url }}" class="product-card--title-link">
        <p class="product-card--title" data-item="{{ heading_type }}">
          {{- title -}}
        </p>
      </a>

      {%- liquid
        if rating_enabled
          render 'product-rating', product: product_item
        endif
      -%}

      {%- if swatch_option -%}
        <div class="product-card--swatches--horizontal-view">
          {%- liquid
            unless hide_single_swatch and swatch_option.values.size == 1
              assign swatch_id = transition_id | append: '--x-view--' | append: product_item.id
              render 'swatches', id: swatch_id, option: swatch_option, grid_item: true, shape: swatches
            endunless
          -%}
        </div>
      {%- endif -%}
    </div>

    {%- render 'product-card--price', product: product_item, onboarding: onboarding -%}
    
    {%- if swatch_option -%}
      <div class="product-card--swatches--column-view">
        {%- liquid
          unless hide_single_swatch and swatch_option.values.size == 1
            assign swatch_id = transition_id | append: '--y-view--' | append: product_item.id
            render 'swatches', id: swatch_id, option: swatch_option, grid_item: true, shape: swatches
          endunless
        -%}
      </div>
    {%- endif -%}
  </div>

  {%- unless onboarding -%}
    <style>
      /* Product Card Details - Force Visibility */
      .product-card--details {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
        padding: 12px 0 !important;
      }
      
      .product-card--details-wrapper {
        display: flex !important;
        flex-direction: column !important;
        gap: 6px !important;
      }
      
      /* Vendor/Brand - Always Show */
      .product-card--vendor {
        display: block !important;
        font-size: 11px !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.8px !important;
        color: #999999 !important;
        margin: 0 !important;
      }
      
      /* Product Title */
      .product-card--title-link {
        text-decoration: none !important;
        color: inherit !important;
      }
      
      .product-card--title {
        display: block !important;
        font-size: 14px !important;
        font-weight: 400 !important;
        line-height: 1.4 !important;
        color: #333333 !important;
        margin: 0 !important;
      }
      
      /* Price Container */
      .product--price-container {
        display: block !important;
        margin: 4px 0 !important;
      }
      
      .product--price-wrapper {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        flex-wrap: wrap !important;
      }
      
      .product--price {
        font-size: 16px !important;
        font-weight: 600 !important;
        color: #000000 !important;
      }
      
      .product--compare-price {
        font-size: 14px !important;
        text-decoration: line-through !important;
        color: #999999 !important;
      }
      
      /* ADD TO CART Button Styling */
      .product-card--add-to-cart-btn {
        width: 100%;
        padding: 14px 20px;
        background-color: #000000;
        color: #ffffff;
        border: none;
        border-radius: 0;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        display: block;
        margin: 12px 0 0 0;
        font-family: inherit;
      }
      
      .product-card--add-to-cart-btn:hover:not(:disabled) {
        background-color: #333333;
        transform: translateY(-1px);
      }
      
      .product-card--add-to-cart-btn:active:not(:disabled) {
        transform: translateY(0);
      }
      
      .product-card--add-to-cart-btn:disabled,
      .product-card--add-to-cart-btn--disabled {
        background-color: #cccccc;
        color: #666666 !important;
        cursor: not-allowed;
        opacity: 0.6;
      }
      
      .product-card--add-to-cart-btn.adding {
        background-color: #555555;
      }
      
      .product-card--add-to-cart-btn.added {
        background-color: #28a745;
      }
    </style>

    <script>
    (function() {
      'use strict';
      
      // Product Card Cart Handler
      class ProductCardCart {
        constructor() {
          this.setupEventListeners();
        }

        setupEventListeners() {
          document.addEventListener('click', (event) => {
            const button = event.target.closest('.product-card--add-to-cart-btn');
            if (button && !button.disabled && !button.classList.contains('adding')) {
              event.preventDefault();
              event.stopPropagation();
              this.handleAddToCart(button);
            }
          });
        }

        async handleAddToCart(button) {
          const variantId = button.getAttribute('data-variant-id');
          
          if (!variantId) {
            console.error('[Product Card] No variant ID found');
            return;
          }
          
          const originalText = button.textContent;
          
          // Update button state
          button.disabled = true;
          button.textContent = 'ADDING...';
          button.classList.add('adding');
          
          try {
            // Add to cart
            const addResponse = await fetch('/cart/add.js', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify({
                id: variantId,
                quantity: 1
              })
            });
            
            if (!addResponse.ok) {
              throw new Error('Failed to add to cart');
            }
            
            await addResponse.json();
            
            // Get updated cart
            const cartResponse = await fetch('/cart.js');
            const cart = await cartResponse.json();
            
            // Update button UI
            button.textContent = 'ADDED!';
            button.classList.remove('adding');
            button.classList.add('added');
            
            // Update header cart count
            this.updateCartCount(cart.item_count);
            
            // Refresh and open cart drawer
            await this.refreshAndOpenCartDrawer();
            
            // Reset button after delay
            setTimeout(() => {
              button.textContent = originalText;
              button.disabled = false;
              button.classList.remove('added');
            }, 1500);
            
          } catch (error) {
            console.error('[Product Card] Error adding to cart:', error);
            button.textContent = 'ERROR';
            setTimeout(() => {
              button.textContent = originalText;
              button.disabled = false;
              button.classList.remove('adding');
            }, 2000);
          }
        }

        updateCartCount(count) {
          // Update all cart count elements
          document.querySelectorAll('[data-cart-count]').forEach(el => {
            el.setAttribute('data-cart-count', count);
          });
          const layoutViewport = document.querySelector('.layout--viewport');
          if (layoutViewport) {
            layoutViewport.setAttribute('data-cart-empty', count === 0 ? 'true' : 'false');
          }
          
          // Update cart badge
          const headerCart = document.querySelector('.header--cart');
          if (headerCart) {
            let badge = headerCart.querySelector('.cart-count-badge');
            
            if (!badge) {
              badge = document.createElement('span');
              badge.className = 'cart-count-badge';
              badge.style.cssText = 'position:absolute!important;top:-8px!important;right:-8px!important;background-color:#d32f2f!important;color:white!important;border-radius:50%!important;min-width:18px!important;height:18px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:11px!important;font-weight:bold!important;z-index:100!important;';
              headerCart.appendChild(badge);
            }
            
            if (count > 0) {
              badge.textContent = count;
              badge.style.display = 'flex';
            } else {
              badge.style.display = 'none';
            }
          }
          
          document.dispatchEvent(new CustomEvent('cart:updated', {
            detail: { itemCount: count }
          }));
        }

        async refreshAndOpenCartDrawer() {
          try {
            console.log('[Product Card] Refreshing cart drawer...');
            const response = await fetch(window.location.origin + '/?sections=cart-drawer&timestamp=' + Date.now(), {
              headers: { 'Cache-Control': 'no-cache' }
            });
            const data = await response.json();
            const cartDrawerHTML = data['cart-drawer'];
            
            if (cartDrawerHTML) {
              const parser = new DOMParser();
              const doc = parser.parseFromString(cartDrawerHTML, 'text/html');
              
              // The cart-drawer section renders cart snippet with view: drawer
              const newCartContent = doc.querySelector('cart-element');
              const currentCartContainer = document.querySelector('.drawer--container[data-view="cart-drawer"] cart-element');
              
              if (newCartContent && currentCartContainer) {
                currentCartContainer.replaceWith(newCartContent);
                console.log('[Product Card] Cart drawer content refreshed (replaced element)');
              } else {
                // Fallback: replace entire drawer container content
                const newContainer = doc.querySelector('cart-element') || doc.body;
                const currentContainer = document.querySelector('.drawer--container[data-view="cart-drawer"]');
                if (currentContainer && newContainer) {
                  currentContainer.innerHTML = newContainer.outerHTML || newContainer.innerHTML;
                  console.log('[Product Card] Cart drawer container refreshed (fallback)');
                }
              }
            }
            
            // Small delay before opening
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Open drawer
            this.openCartDrawer();
            
          } catch (error) {
            console.error('[Product Card] Error refreshing cart:', error);
            // Still try to open drawer even if refresh fails
            this.openCartDrawer();
          }
        }

        openCartDrawer() {
          console.log('[Product Card] Opening cart drawer...');
          
          // Method 1: Click the header cart link (most reliable - uses theme's native drawer system)
          const headerCartLink = document.querySelector('.header--cart[data-drawer-open="right"][data-drawer-view="cart-drawer"]');
          if (headerCartLink) {
            headerCartLink.click();
            console.log('[Product Card] Opened via header cart link click');
            return;
          }
          
          // Method 2: Click any element with cart drawer attributes
          const cartLink = document.querySelector('a.header--cart') || document.querySelector('.header--cart');
          if (cartLink) {
            cartLink.click();
            console.log('[Product Card] Opened via header cart element click');
            return;
          }
          
          // Method 3: Directly manipulate the drawer element (fallback)
          const drawerSide = document.querySelector('.drawer--side[data-side="right"]');
          if (drawerSide) {
            drawerSide.setAttribute('aria-expanded', 'true');
            
            // Also show the correct view
            const cartView = drawerSide.querySelector('.drawer--container[data-view="cart-drawer"]');
            if (cartView) {
              // Hide all other views in right drawer
              drawerSide.querySelectorAll('.drawer--container').forEach(c => {
                c.style.display = 'none';
              });
              cartView.style.display = '';
            }
            
            // Show overlay
            const overlay = document.querySelector('.drawer--overlay');
            if (overlay) overlay.setAttribute('aria-hidden', 'false');
            
            document.body.style.overflow = 'hidden';
            console.log('[Product Card] Opened via direct drawer manipulation');
            return;
          }
          
          console.warn('[Product Card] Could not find any way to open cart drawer');
        }
      }

      // Initialize when DOM is ready
      function initProductCardCart() {
        if (!window.productCardCartInitialized) {
          new ProductCardCart();
          window.productCardCartInitialized = true;
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initProductCardCart);
      } else {
        initProductCardCart();
      }
    })();
    </script>
  {%- endunless -%}
</{{ tag }}>